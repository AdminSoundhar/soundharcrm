
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JewelFlow CRM - Lead Management</title>
    
    <!-- Styling & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone for JSX parsing in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-display { font-family: 'Playfair Display', serif; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // 1. Explicitly import React and ReactDOM from ESM CDN
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@19';
        import ReactDOM from 'https://esm.sh/react-dom@19/client';
        
        // 2. Attach to window so Babel's generated React.createElement works
        window.React = React;
        window.ReactDOM = ReactDOM;

        // 3. Import other dependencies
        import { 
            LayoutDashboard, Users, UserPlus, PieChart, Gem, LogOut, 
            ShieldCheck, Settings as SettingsIcon, Search, Filter, 
            MoreHorizontal, Phone, MessageSquare, Mail, BrainCircuit, 
            ExternalLink, Eye, Save, User as UserIcon, FileText, 
            IndianRupee, Weight, UserCircle, Share2, Box, ArrowLeft, 
            Calendar, Clock, Send, Lock, ChevronRight, Trash2, Plus, X 
        } from 'https://esm.sh/lucide-react';
        
        import { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, PieChart as RePieChart, Pie, Cell 
        } from 'https://esm.sh/recharts';

        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai';

        // --- CONSTANTS ---
        const METAL_GROUPS = ['Gold', 'Diamond', 'Platinum', 'Silver'];
        const STATUS_COLORS = {
            'New': 'bg-blue-100 text-blue-700',
            'Contacted': 'bg-purple-100 text-purple-700',
            'Qualified': 'bg-indigo-100 text-indigo-700',
            'Negotiating': 'bg-amber-100 text-amber-700',
            'Closed': 'bg-emerald-100 text-emerald-700',
            'Lost': 'bg-rose-100 text-rose-700',
        };

        // --- COMPONENTS ---

        const Sidebar = ({ currentView, setView, currentUser, onLogout }) => {
            const menuItems = [
                { id: 'dashboard', label: 'Overview', icon: LayoutDashboard, roles: ['Admin', 'Manager', 'Sales'] },
                { id: 'leads', label: 'Lead Pipeline', icon: Users, roles: ['Admin', 'Manager', 'Sales'] },
                { id: 'add-lead', label: 'New Lead', icon: UserPlus, roles: ['Admin', 'Manager', 'Sales'] },
                { id: 'user-mgmt', label: 'Team Access', icon: ShieldCheck, roles: ['Admin'] },
                { id: 'settings', label: 'Settings', icon: SettingsIcon, roles: ['Admin'] },
            ];
            const filteredItems = menuItems.filter(item => item.roles.includes(currentUser.role));

            return (
                <aside className="w-64 bg-slate-900 h-screen flex flex-col sticky top-0 shadow-2xl">
                    <div className="p-6 flex items-center gap-3">
                        <div className="bg-amber-500 p-2 rounded-lg"><Gem className="text-white h-6 w-6" /></div>
                        <h1 className="text-xl font-bold text-white tracking-tight font-display">JewelFlow</h1>
                    </div>
                    <nav className="flex-1 px-4 mt-4 space-y-1">
                        {filteredItems.map((item) => {
                            const Icon = item.icon;
                            const isActive = currentView === item.id;
                            return (
                                <button key={item.id} onClick={() => setView(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all ${isActive ? 'bg-amber-500 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>
                                    <Icon size={18} /> {item.label}
                                </button>
                            );
                        })}
                    </nav>
                    <div className="p-4 border-t border-slate-800">
                        <div className="flex items-center gap-3 px-4 py-3 mb-2">
                            <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold text-xs border border-slate-700">{currentUser.name.charAt(0)}</div>
                            <div className="overflow-hidden">
                                <p className="text-sm font-medium text-white truncate">{currentUser.name}</p>
                                <p className="text-[10px] font-black uppercase text-amber-500 tracking-widest">{currentUser.role}</p>
                            </div>
                        </div>
                        <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium text-slate-400 hover:text-rose-400 transition-colors"><LogOut size={18} /> Sign Out</button>
                    </div>
                </aside>
            );
        };

        const Dashboard = ({ leads }) => {
            const COLORS = ['#F59E0B', '#10B981', '#3B82F6', '#8B5CF6'];
            const stats = [
                { label: 'Total Leads', value: leads.length, icon: Users, color: 'bg-blue-50 text-blue-600' },
                { label: 'Qualified', value: leads.filter(l => l.status === 'Qualified').length, icon: ShieldCheck, color: 'bg-amber-50 text-amber-600' },
                { label: 'Deals Won', value: leads.filter(l => l.status === 'Closed').length, icon: Gem, color: 'bg-emerald-50 text-emerald-600' },
            ];

            const metalData = METAL_GROUPS.map(m => ({ name: m, value: leads.filter(l => l.metalGroup === m).length }));

            return (
                <div className="p-8 space-y-8 animate-in">
                    <header>
                        <h1 className="text-3xl font-bold text-slate-900 font-display">Sales Overview</h1>
                        <p className="text-slate-500 mt-1">Real-time jewelry pipeline analytics.</p>
                    </header>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {stats.map(stat => (
                            <div key={stat.label} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <div className={`${stat.color} p-3 rounded-xl w-fit mb-4`}><stat.icon size={24} /></div>
                                <p className="text-slate-500 text-sm">{stat.label}</p>
                                <h3 className="text-2xl font-bold text-slate-900 mt-1">{stat.value}</h3>
                            </div>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-white p-8 rounded-2xl border border-slate-200 h-96">
                            <h3 className="text-lg font-bold text-slate-900 mb-6 font-display">Metal Interest</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <RePieChart>
                                    <Pie data={metalData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                        {metalData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                    </Pie>
                                    <Tooltip />
                                </RePieChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="bg-white p-8 rounded-2xl border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-900 mb-6 font-display">Recent Prospects</h3>
                            <div className="space-y-4">
                                {leads.slice(0, 5).map(lead => (
                                    <div key={lead.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                        <div>
                                            <p className="text-sm font-bold text-slate-900">{lead.customerName}</p>
                                            <p className="text-[10px] text-slate-500 uppercase">{lead.metalGroup} {lead.productCategory}</p>
                                        </div>
                                        <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${STATUS_COLORS[lead.status]}`}>{lead.status}</span>
                                    </div>
                                ))}
                                {leads.length === 0 && <p className="text-center text-slate-400 py-10 italic">No leads registered yet.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LeadTable = ({ leads, onUpdateStatus, onViewDetails }) => {
            return (
                <div className="p-8 space-y-6 animate-in">
                    <header>
                        <h1 className="text-3xl font-bold text-slate-900 font-display">Lead Pipeline</h1>
                        <p className="text-slate-500">Manage and track your customer journey.</p>
                    </header>
                    <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Customer</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Category</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Status</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {leads.map(lead => (
                                    <tr key={lead.id} className="hover:bg-slate-50 transition-colors group">
                                        <td className="px-6 py-5">
                                            <p className="font-bold text-slate-900">{lead.customerName}</p>
                                            <p className="text-xs text-slate-500">{lead.mobile}</p>
                                        </td>
                                        <td className="px-6 py-5">
                                            <p className="text-sm text-slate-700 font-medium">{lead.productCategory}</p>
                                        </td>
                                        <td className="px-6 py-5">
                                            <select value={lead.status} onChange={(e) => onUpdateStatus(lead.id, e.target.value)} className={`px-2 py-1 rounded text-xs font-bold uppercase outline-none border-none ${STATUS_COLORS[lead.status]}`}>
                                                {Object.keys(STATUS_COLORS).map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </td>
                                        <td className="px-6 py-5 text-right">
                                            <button onClick={() => onViewDetails(lead.id)} className="p-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-900 hover:text-white transition-all"><Eye size={16} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('admin@jewelflow.com');
            return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white/5 backdrop-blur-xl border border-white/10 p-10 rounded-3xl shadow-2xl text-center">
                        <div className="bg-amber-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6"><Gem className="text-white" size={32} /></div>
                        <h1 className="text-3xl font-bold text-white font-display mb-2">JewelFlow CRM</h1>
                        <p className="text-slate-400 mb-8">Secure Enterprise Access</p>
                        <form onSubmit={(e) => { e.preventDefault(); onLogin({ id: '1', name: 'Admin', role: 'Admin', email }); }} className="space-y-4">
                            <input value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white outline-none focus:ring-2 focus:ring-amber-500" placeholder="Email Address" />
                            <input type="password" value="password" className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white outline-none focus:ring-2 focus:ring-amber-500" placeholder="Password" />
                            <button type="submit" className="w-full py-4 bg-amber-500 text-white font-bold rounded-xl shadow-lg hover:bg-amber-400 transition-all mt-4">Sign In</button>
                        </form>
                    </div>
                </div>
            );
        };

        const LeadForm = ({ onSave, onCancel, currentUser }) => {
            const [formData, setFormData] = useState({ customerName: '', mobile: '', email: '', metalGroup: 'Gold', productCategory: 'Necklace', budget: '', description: '', source: 'Whatsapp', leadGeneratorId: currentUser.id, leadGeneratorName: currentUser.name });
            return (
                <div className="p-8 max-w-4xl mx-auto animate-in">
                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="p-8 bg-slate-50 border-b border-slate-200"><h2 className="text-2xl font-bold font-display">New Sales Lead</h2></div>
                        <form className="p-8 space-y-6" onSubmit={e => { e.preventDefault(); onSave(formData); }}>
                            <div className="grid grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Customer Name</label>
                                    <input required value={formData.customerName} onChange={e => setFormData({...formData, customerName: e.target.value})} className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-amber-500" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Mobile</label>
                                    <input required value={formData.mobile} onChange={e => setFormData({...formData, mobile: e.target.value})} className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-amber-500" />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Metal</label>
                                    <select value={formData.metalGroup} onChange={e => setFormData({...formData, metalGroup: e.target.value})} className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                                        {METAL_GROUPS.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Budget (â‚¹)</label>
                                    <input value={formData.budget} onChange={e => setFormData({...formData, budget: e.target.value})} className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg" />
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 pt-6 border-t border-slate-100">
                                <button type="button" onClick={onCancel} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold">Cancel</button>
                                <button type="submit" className="px-8 py-2 bg-amber-500 text-white rounded-xl font-bold shadow-lg">Register Lead</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('jf_user') || 'null'));
            const [view, setView] = useState('dashboard');
            const [leads, setLeads] = useState(() => JSON.parse(localStorage.getItem('jf_leads') || '[]'));
            const [selectedId, setSelectedId] = useState(null);

            useEffect(() => { if (currentUser) localStorage.setItem('jf_user', JSON.stringify(currentUser)); }, [currentUser]);
            useEffect(() => { localStorage.setItem('jf_leads', JSON.stringify(leads)); }, [leads]);

            const handleAddLead = (data) => {
                const newLead = { ...data, id: Date.now().toString(), createdAt: new Date().toISOString(), status: 'New' };
                setLeads([newLead, ...leads]);
                setView('leads');
            };

            const handleUpdateStatus = (id, status) => {
                setLeads(leads.map(l => l.id === id ? { ...l, status } : l));
            };

            if (!currentUser) return <Login onLogin={setCurrentUser} />;

            return (
                <div className="flex min-h-screen">
                    <Sidebar currentView={view} setView={setView} currentUser={currentUser} onLogout={() => { localStorage.removeItem('jf_user'); setCurrentUser(null); }} />
                    <main className="flex-1 overflow-y-auto bg-slate-50 max-h-screen">
                        <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-md px-8 py-4 border-b border-slate-200 flex justify-between items-center">
                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">JewelFlow / {view}</span>
                            <div className="flex gap-4">
                                {view !== 'add-lead' && <button onClick={() => setView('add-lead')} className="bg-amber-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm">+ New Lead</button>}
                            </div>
                        </header>
                        {view === 'dashboard' && <Dashboard leads={leads} />}
                        {view === 'leads' && <LeadTable leads={leads} onUpdateStatus={handleUpdateStatus} onViewDetails={(id) => { setSelectedId(id); setView('lead-details'); }} />}
                        {view === 'add-lead' && <LeadForm onSave={handleAddLead} onCancel={() => setView('leads')} currentUser={currentUser} />}
                        {view === 'lead-details' && (
                            <div className="p-8 animate-in">
                                <button onClick={() => setView('leads')} className="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-900"><ArrowLeft size={16}/> Back</button>
                                <div className="bg-white p-10 rounded-3xl border border-slate-200 shadow-sm">
                                    <h2 className="text-3xl font-bold font-display mb-4">{leads.find(l => l.id === selectedId)?.customerName}</h2>
                                    <p className="text-slate-500">Detailed profiling view for internal record keeping.</p>
                                </div>
                            </div>
                        )}
                        {['user-mgmt', 'settings'].includes(view) && (
                            <div className="flex items-center justify-center h-96 text-slate-400 italic">Configuration module is restricted for the demo.</div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
