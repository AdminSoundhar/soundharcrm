
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JewelFlow CRM - Lead Management</title>
    
    <!-- Styling & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone for JSX parsing in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .font-display { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .auth-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loader-ring {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.462.0",
    "recharts": "https://esm.sh/recharts@^2.13.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            LayoutDashboard, Gem, LogOut, ShieldCheck, 
            Settings as SettingsIcon, Trash2, ChevronRight, Save, 
            RefreshCcw, ShieldAlert, X, ExternalLink, Cloud, CloudOff, Info, AlertCircle
        } from 'lucide-react';

        // DEFAULT HARDCODED CONFIGURATION
        const GITHUB_CONFIG = {
            owner: 'AdminSoundhar',
            repo: 'soundharcrm',
            token: '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' 
        };

        const CSV_FILENAME = 'Team Access.csv';

        // Robust CSV Parser
        const parseCSV = (text) => {
            if (!text) return [];
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            return lines.slice(1).map(line => {
                const parts = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { parts.push(current.trim()); current = ""; }
                    else current += char;
                }
                parts.push(current.trim());
                
                if (parts.length < 4) return null;
                return {
                    id: Math.random().toString(36).substr(2, 9),
                    name: parts[0],
                    email: parts[1].toLowerCase(),
                    role: parts[2] || 'Sales',
                    password: parts[3],
                    createdAt: parts[4] || new Date().toISOString(),
                };
            }).filter(u => u !== null);
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('jf_user') || 'null'));
            const [view, setView] = useState('dashboard');
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('jf_users') || '[]'));
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncError, setSyncError] = useState(null);

            useEffect(() => { localStorage.setItem('jf_users', JSON.stringify(users)); }, [users]);
            useEffect(() => { if (currentUser) localStorage.setItem('jf_user', JSON.stringify(currentUser)); }, [currentUser]);

            // Use GitHub API for fetching (bypass raw cache)
            const fetchRepoDatabase = useCallback(async () => {
                setIsSyncing(true);
                setSyncError(null);
                try {
                    const filePath = encodeURIComponent(CSV_FILENAME);
                    const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}?t=${Date.now()}`;
                    
                    const headers = { 
                        'Authorization': `Bearer ${GITHUB_CONFIG.token.trim()}`,
                        'Accept': 'application/vnd.github+json'
                    };
                    
                    const response = await fetch(apiUrl, { headers });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const text = atob(data.content);
                        const parsed = parseCSV(text);
                        setUsers(parsed);
                        return parsed;
                    } else {
                        const err = await response.json();
                        setSyncError(`Fetch Failed (${response.status}): ${err.message}`);
                        // If 401, likely token revoked
                        if (response.status === 401) {
                            setSyncError("Access Token Revoked: GitHub security disabled the token. Please update the PAT in the code.");
                        }
                    }
                } catch (e) { 
                    setSyncError(`Network Error: ${e.message}`);
                } finally { 
                    setIsSyncing(false); 
                }
                return null;
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                const email = e.target.email.value.trim().toLowerCase();
                const password = e.target.password.value.trim();
                
                // Fetch latest from CSV before login to ensure we have current data
                const latest = await fetchRepoDatabase();
                const targetList = latest || users;
                
                const found = targetList.find(u => u.email.toLowerCase() === email && u.password === password);
                if (found) setCurrentUser(found);
                else alert("Invalid Credentials: User not found in 'Team Access.csv'.");
            };

            useEffect(() => { fetchRepoDatabase(); }, []);

            if (!currentUser) return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 relative">
                    <div className="w-full max-w-md auth-card p-12 rounded-[48px] shadow-2xl text-center text-white animate-in relative z-10">
                        <div className="bg-amber-500 w-20 h-20 rounded-[28px] flex items-center justify-center mx-auto mb-10 shadow-xl">
                            <Gem className="text-white" size={36}/>
                        </div>
                        <h1 className="text-4xl font-bold font-display mb-12 tracking-tight">JewelFlow</h1>
                        
                        <form onSubmit={handleLogin} className="space-y-6 text-left">
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Enterprise Email</label>
                                <input name="email" required type="email" className="w-full px-6 py-4 bg-white/5 border border-white/10 rounded-2xl outline-none text-white focus:ring-1 focus:ring-amber-500" placeholder="admin@jewelflow.com" />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Password Key</label>
                                <input name="password" required type="password" className="w-full px-6 py-4 bg-white/5 border border-white/10 rounded-2xl outline-none text-white focus:ring-1 focus:ring-amber-500" placeholder="••••••••" />
                            </div>
                            <button disabled={isSyncing} type="submit" className="w-full py-5 bg-amber-500 text-slate-900 font-black text-xs uppercase tracking-[3px] rounded-2xl shadow-xl hover:bg-amber-400 transition-all flex items-center justify-center gap-2">
                                {isSyncing ? <div className="loader-ring"></div> : 'Authorize Entry'}
                            </button>
                        </form>
                        
                        {syncError && (
                            <div className="mt-8 p-4 bg-rose-500/10 border border-rose-500/20 rounded-2xl text-[10px] text-rose-400 font-bold uppercase tracking-widest">
                                {syncError}
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="flex min-h-screen bg-slate-50">
                    <aside className="w-64 bg-slate-900 h-screen flex flex-col sticky top-0 shadow-2xl z-20">
                        <div className="p-6 flex items-center gap-3">
                            <div className="bg-amber-500 p-2 rounded-lg"><Gem className="text-white h-6 w-6" /></div>
                            <h1 className="text-xl font-bold text-white tracking-tight font-display">JewelFlow</h1>
                        </div>
                        <nav className="flex-1 px-4 mt-4 space-y-1">
                            <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all ${view === 'dashboard' ? 'bg-amber-500 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}><LayoutDashboard size={18}/> Overview</button>
                            <button onClick={() => setView('user-mgmt')} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all ${view === 'user-mgmt' ? 'bg-amber-500 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}><ShieldCheck size={18}/> Team Access</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={() => {localStorage.removeItem('jf_user'); setCurrentUser(null);}} className="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium text-slate-400 hover:text-rose-400 transition-colors"><LogOut size={18} /> Sign Out</button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto max-h-screen">
                        <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-xl px-10 py-6 border-b border-slate-200/50 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-[3px]">Engine</span>
                                <ChevronRight size={14} className="text-slate-300" />
                                <span className="text-[10px] font-black text-slate-900 uppercase tracking-[3px] font-mono">{view}</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`flex items-center gap-2 px-4 py-1.5 rounded-full ${syncError ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-500'}`}>
                                    {isSyncing ? <div className="loader-ring text-amber-500"></div> : (syncError ? <CloudOff size={14} /> : <Cloud size={14} />)}
                                    <p className="text-[10px] font-black uppercase tracking-widest">{syncError ? 'Disconnected' : 'Cloud Synced'}</p>
                                </div>
                                <button onClick={fetchRepoDatabase} className="p-2 text-slate-400 hover:text-slate-900 transition-colors" title="Force Refresh"><RefreshCcw size={18} className={isSyncing ? 'animate-spin' : ''} /></button>
                            </div>
                        </header>
                        
                        {view === 'user-mgmt' ? (
                            <div className="p-10 animate-in">
                                <header className="flex justify-between items-center mb-10">
                                    <div>
                                        <h1 className="text-3xl font-bold font-display">Manage Team Database</h1>
                                        <p className="text-slate-400 text-sm mt-1">Live Feed from: <b className="text-slate-600 font-mono text-[10px] tracking-tight">{GITHUB_CONFIG.repo}/{CSV_FILENAME}</b></p>
                                    </div>
                                    <div className="bg-slate-100 px-6 py-3 rounded-2xl flex items-center gap-3 text-slate-500">
                                        <Info size={16}/>
                                        <p className="text-[10px] font-bold uppercase tracking-widest">Read-Only Mode: Managed via CSV</p>
                                    </div>
                                </header>
                                
                                {syncError && (
                                    <div className="mb-8 p-6 bg-rose-50 border border-rose-200 rounded-[32px] flex items-start gap-4 animate-in">
                                        <div className="p-3 bg-rose-100 rounded-2xl text-rose-600"><ShieldAlert size={24} /></div>
                                        <div className="flex-1">
                                            <p className="text-sm font-black text-rose-900 uppercase tracking-widest flex items-center gap-2">Sync Engine Failure <AlertCircle size={14}/></p>
                                            <p className="text-xs text-rose-600 mt-1 leading-relaxed font-mono">{syncError}</p>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="bg-white rounded-[40px] border border-slate-200 overflow-hidden shadow-sm">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[3px]">Identity</th>
                                                <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[3px]">Role</th>
                                                <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[3px]">Auth Key</th>
                                                <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[3px]">Created</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {users.map(u => (
                                                <tr key={u.email} className="hover:bg-slate-50/30 transition-colors">
                                                    <td className="px-8 py-6">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center text-white font-bold text-sm shadow-md">{u.name.charAt(0)}</div>
                                                            <div><p className="font-bold text-sm text-slate-900">{u.name}</p><p className="text-xs text-slate-400 font-mono mt-0.5">{u.email}</p></div>
                                                        </div>
                                                    </td>
                                                    <td className="px-8 py-6"><span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${u.role === 'Admin' ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-600'}`}>{u.role}</span></td>
                                                    <td className="px-8 py-6 text-xs text-slate-400 font-mono tracking-tighter">{u.password}</td>
                                                    <td className="px-8 py-6 text-xs text-slate-400">{new Date(u.createdAt).toLocaleDateString()}</td>
                                                </tr>
                                            ))}
                                            {users.length === 0 && !isSyncing && (
                                                <tr>
                                                    <td colSpan="4" className="px-8 py-12 text-center text-slate-400 italic text-sm">No members found in CSV database.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="p-10 animate-in">
                                <h1 className="text-3xl font-bold font-display">System Overview</h1>
                                <div className="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Cloud Health</p>
                                        <div className="flex items-center gap-3"><div className={`w-3 h-3 rounded-full shadow-lg ${syncError ? 'bg-rose-500 animate-pulse' : 'bg-emerald-500'}`}></div><h3 className="text-xl font-bold">{syncError ? 'Disconnected' : 'Operational'}</h3></div>
                                    </div>
                                    <div className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm hover:shadow-md transition-shadow"><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Total Users</p><h3 className="text-3xl font-bold">{users.length} Records</h3></div>
                                    <div className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm hover:shadow-md transition-shadow"><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Repository</p><h3 className="text-sm font-mono font-bold truncate text-slate-600">{GITHUB_CONFIG.owner}/{GITHUB_CONFIG.repo}</h3></div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
